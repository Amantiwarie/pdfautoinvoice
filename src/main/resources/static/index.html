<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Invoice Generator</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 24px; max-width: 720px; margin: auto; }
    label { display:block; margin-top:12px; }
    select,input { width:100%; padding:8px; margin-top:6px; }
    button { margin-top:12px; padding:10px 16px; }
    .status { margin-top:12px; color: green; }
    .error { margin-top:12px; color: red; }
  </style>
</head>
<body>
  <h2>Invoice Generator</h2>
  <div>
    <label>Dealer
      <select id="dealer"></select>
    </label>
    <label>Vehicle
      <select id="vehicle"></select>
    </label>
    <label>Customer Name
      <input id="customer" placeholder="Customer Name"/>
    </label>
    <button id="gen">Generate Invoice (download PDF)</button>

    <div class="status" id="status"></div>
    <div class="error" id="error"></div>
  </div>

<script>
async function loadData() {
  try {
    const d = await fetch('/api/dealers').then(r=>r.json());
    const v = await fetch('/api/vehicles').then(r=>r.json());
    const dealerSel = document.getElementById('dealer');
    d.forEach(x => {
      const opt = document.createElement('option');
      opt.value = x.id; opt.text = x.name + ' ('+x.id+')';
      dealerSel.appendChild(opt);
    });
    const vehicleSel = document.getElementById('vehicle');
    v.forEach(x => {
      const opt = document.createElement('option');
      opt.value = x.id; opt.text = x.make + ' ' + x.model + ' - â‚¹' + x.price;
      vehicleSel.appendChild(opt);
    });
  } catch(e) {
    document.getElementById('error').innerText = 'Failed to load data: ' + e;
  }
}

document.getElementById('gen').addEventListener('click', async () => {
  document.getElementById('status').innerText=''; document.getElementById('error').innerText='';
  const dealerId = Number(document.getElementById('dealer').value);
  const vehicleId = Number(document.getElementById('vehicle').value);
  const customerName = document.getElementById('customer').value.trim();
  if(!customerName){ document.getElementById('error').innerText='Enter customer name'; return; }
  try {
    const resp = await fetch('/api/invoices', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({dealerId, vehicleId, customerName})
    });
    if(!resp.ok){ const t = await resp.text(); throw new Error(t || resp.status); }
    const blob = await resp.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'invoice.pdf';
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
    document.getElementById('status').innerText = 'Invoice downloaded.';
  } catch(e) {
    document.getElementById('error').innerText = 'Error: ' + e.message;
  }
});

loadData();
</script>
</body>
</html>
